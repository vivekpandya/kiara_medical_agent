<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveKit Voice Chat Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">LiveKit Voice Chat Test</h1>
                
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-microphone"></i> Voice Chat with Our Agent</h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Voice Chat Container -->
                        <div id="voiceChatContainer" style="height: 300px; padding: 20px; background-color: #f8f9fa; text-align: center;">
                            <div id="voiceChatContent">
                                <i class="fas fa-microphone fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">Click "Start Voice Chat" to begin talking with our agent</h6>
                                <p class="small text-muted">You can speak directly to our support agent</p>
                            </div>
                            
                            <!-- Audio Controls -->
                            <div id="audioControls" style="display: none;">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="mb-2">
                                                <i class="fas fa-microphone fa-2x text-success"></i>
                                            </div>
                                            <small class="text-muted">Your Microphone</small>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-danger" id="muteBtn">
                                                    <i class="fas fa-microphone-slash"></i> Mute
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="mb-2">
                                                <i class="fas fa-headphones fa-2x text-primary"></i>
                                            </div>
                                            <small class="text-muted">Agent Audio</small>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-secondary" id="volumeBtn">
                                                    <i class="fas fa-volume-up"></i> Volume
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Speaking Indicator -->
                                <div id="speakingIndicator" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="fas fa-comment-dots"></i> <span id="speakingText">Agent is speaking...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Voice Chat Controls -->
                        <div class="border-top p-3 bg-light">
                            <div class="row">
                                <div class="col-md-6">
                                    <button class="btn btn-success btn-lg" id="startVoiceChatBtn">
                                        <i class="fas fa-play"></i> Start Voice Chat
                                    </button>
                                    <button class="btn btn-danger btn-lg" id="endVoiceChatBtn" disabled>
                                        <i class="fas fa-stop"></i> End Call
                                    </button>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small class="text-muted">
                                        Status: <span id="voiceChatStatus" class="badge bg-secondary">Disconnected</span>
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <span id="connectionInfo">Click start to connect</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Instructions:</h6>
                    <ol>
                        <li>Click "Start Voice Chat" to connect</li>
                        <li>Allow microphone access when prompted</li>
                        <li>Speak directly to the agent</li>
                        <li>Use mute button to mute/unmute yourself</li>
                        <li>Click "End Call" when finished</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/livekit-client@latest/dist/livekit-client.umd.js"></script>
    <script>
        // LiveKit Voice Chat Agent Implementation
        class ContactVoiceChatAgent {
            constructor() {
                this.room = null;
                this.isConnected = false;
                this.isMuted = false;
                this.agentIdentity = 'support-agent';
                this.userIdentity = 'user-' + Date.now();
                this.initializeElements();
                this.attachEventListeners();
            }

            initializeElements() {
                this.voiceChatContainer = document.getElementById('voiceChatContainer');
                this.voiceChatContent = document.getElementById('voiceChatContent');
                this.audioControls = document.getElementById('audioControls');
                this.speakingIndicator = document.getElementById('speakingIndicator');
                this.speakingText = document.getElementById('speakingText');
                this.startVoiceChatBtn = document.getElementById('startVoiceChatBtn');
                this.endVoiceChatBtn = document.getElementById('endVoiceChatBtn');
                this.voiceChatStatus = document.getElementById('voiceChatStatus');
                this.connectionInfo = document.getElementById('connectionInfo');
                this.muteBtn = document.getElementById('muteBtn');
                this.volumeBtn = document.getElementById('volumeBtn');
            }

            attachEventListeners() {
                this.startVoiceChatBtn.addEventListener('click', () => this.startVoiceChat());
                this.endVoiceChatBtn.addEventListener('click', () => this.endVoiceChat());
                this.muteBtn.addEventListener('click', () => this.toggleMute());
                this.volumeBtn.addEventListener('click', () => this.toggleVolume());
            }

            async startVoiceChat() {
                try {
                    this.updateStatus('connecting', 'Connecting...');
                    this.connectionInfo.textContent = 'Connecting to voice chat...';
                    
                    // Get access token from server
                    const response = await fetch('http://localhost:8080/livekit/generateToken', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            room_name: 'voice-support',
                            participant_name: 'Customer',
                            participant_identity: this.userIdentity
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error);
                    }
                    
                    // Connect to LiveKit room with audio configuration
                    this.room = new LiveKit.Room({
                        adaptiveStream: true,
                        dynacast: true,
                        publishDefaults: {
                            audioPreset: LiveKit.AudioPresets.music
                        }
                    });
                    
                    this.setupRoomEventListeners();
                    
                    // Connect to room
                    await this.room.connect('ws://localhost:7880', data.token);
                    
                    // Enable microphone and audio
                    await this.room.localParticipant.enableCameraAndMicrophone();
                    
                    this.isConnected = true;
                    this.updateStatus('connected', 'Connected');
                    this.updateUI();
                    this.showAudioControls();
                    this.connectionInfo.textContent = 'Connected! You can now speak with our agent.';
                    
                } catch (error) {
                    console.error('Failed to start voice chat:', error);
                    this.updateStatus('disconnected', 'Connection Failed');
                    this.connectionInfo.textContent = 'Failed to connect. Please try again.';
                    alert('Failed to start voice chat: ' + error.message);
                }
            }

            setupRoomEventListeners() {
                this.room.on(LiveKit.RoomEvent.ParticipantConnected, (participant) => {
                    if (participant.identity !== this.userIdentity) {
                        this.showSpeakingIndicator('Support agent joined the call');
                        setTimeout(() => this.hideSpeakingIndicator(), 3000);
                    }
                });
                
                this.room.on(LiveKit.RoomEvent.ParticipantDisconnected, (participant) => {
                    if (participant.identity !== this.userIdentity) {
                        this.showSpeakingIndicator('Support agent left the call');
                        setTimeout(() => this.hideSpeakingIndicator(), 3000);
                    }
                });
                
                this.room.on(LiveKit.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    if (track.kind === 'audio' && participant.identity !== this.userIdentity) {
                        // Agent is speaking
                        this.showSpeakingIndicator('Agent is speaking...');
                        track.attach();
                    }
                });
                
                this.room.on(LiveKit.RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
                    if (track.kind === 'audio' && participant.identity !== this.userIdentity) {
                        this.hideSpeakingIndicator();
                    }
                });
                
                this.room.on(LiveKit.RoomEvent.Disconnected, () => {
                    this.handleDisconnection();
                });
            }

            async toggleMute() {
                if (!this.room) return;
                
                try {
                    if (this.isMuted) {
                        await this.room.localParticipant.setMicrophoneEnabled(true);
                        this.isMuted = false;
                        this.muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i> Mute';
                        this.muteBtn.className = 'btn btn-sm btn-outline-danger';
                    } else {
                        await this.room.localParticipant.setMicrophoneEnabled(false);
                        this.isMuted = true;
                        this.muteBtn.innerHTML = '<i class="fas fa-microphone"></i> Unmute';
                        this.muteBtn.className = 'btn btn-sm btn-success';
                    }
                } catch (error) {
                    console.error('Failed to toggle mute:', error);
                }
            }

            toggleVolume() {
                // Volume control implementation
                alert('Volume control feature coming soon!');
            }

            showAudioControls() {
                this.voiceChatContent.style.display = 'none';
                this.audioControls.style.display = 'block';
            }

            showSpeakingIndicator(text) {
                this.speakingText.textContent = text;
                this.speakingIndicator.style.display = 'block';
            }

            hideSpeakingIndicator() {
                this.speakingIndicator.style.display = 'none';
            }

            async endVoiceChat() {
                if (this.room) {
                    try {
                        await this.room.disconnect();
                    } catch (error) {
                        console.error('Error disconnecting:', error);
                    }
                }
                this.handleDisconnection();
            }

            handleDisconnection() {
                this.isConnected = false;
                this.room = null;
                this.updateStatus('disconnected', 'Disconnected');
                this.updateUI();
                this.connectionInfo.textContent = 'Voice chat ended. Thank you for contacting us!';
                this.voiceChatContent.style.display = 'block';
                this.audioControls.style.display = 'none';
                this.hideSpeakingIndicator();
            }

            updateStatus(status, text) {
                this.voiceChatStatus.className = `badge bg-${status === 'connected' ? 'success' : status === 'connecting' ? 'warning' : 'secondary'}`;
                this.voiceChatStatus.textContent = text;
            }

            updateUI() {
                this.startVoiceChatBtn.disabled = this.isConnected;
                this.endVoiceChatBtn.disabled = !this.isConnected;
            }
        }

        // Initialize voice chat agent when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.contactVoiceChatAgent = new ContactVoiceChatAgent();
        });
    </script>
</body>
</html>
